<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dylan AI - Trading Assistant</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#3b82f6',secondary:'#f59e0b'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
html, body {
    scroll-behavior: smooth;
}
body {
    font-family: 'Inter', sans-serif;
    background: #000000;
    overflow-x: hidden;
}
.orb {
    width: 400px;
    height: 400px;
    border-radius: 50%;
    position: relative;
    transform-style: preserve-3d;
    margin: 2rem 0;
}
.orb-inner {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(234, 179, 8, 0.8), rgba(234, 179, 8, 0.4) 40%, rgba(234, 179, 8, 0.1) 80%);
    box-shadow: 0 0 120px rgba(234, 179, 8, 0.4);
    animation: pulse 4s infinite ease-in-out;
}
.glassmorphism {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(234, 179, 8, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
.overlay {
    transform: translateY(100%);
    transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
.overlay.active {
    transform: translateY(0);
}
.start-btn { position: relative; overflow: hidden; }
.start-btn::after {
    content: ''; position: absolute; top: -30%; left: -50%; width: 60%; height: 60%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transform: rotate(45deg); animation: shine 3s infinite;
}
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } }
@keyframes shine { 0% { left: -100%; } 20% { left: 100%; } 100% { left: 100%; } }
</style>
</head>
<body class="text-white">
<div class="min-h-screen flex flex-col items-center px-4 py-8 relative">
    <div class="text-center mb-8 mt-16">
        <h1 class="text-6xl mb-4 font-['Pacifico'] text-center text-yellow-500 drop-shadow-lg">Dylan AI</h1>
        <p class="text-lg text-yellow-100 tracking-wide">Setting a new standard in digital trading</p>
    </div>
    <div class="orb mb-12" id="orb">
        <div class="orb-inner"></div>
    </div>
    <button id="startBtn" class="start-btn bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-4 px-12 rounded-full shadow-lg transition-all duration-300 whitespace-nowrap text-xl mt-12 border border-yellow-400 disabled:opacity-50 disabled:cursor-wait">
        Start Analysis
    </button>
</div>

<div id="overlay" class="overlay fixed bottom-0 left-0 right-0 h-[85vh] z-10 flex justify-center items-center">
    <div class="container mx-auto px-4 h-full flex flex-col">
        <div class="flex justify-end mb-4 space-x-2">
            <button id="shutdownBtn" class="w-10 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 !rounded-full text-white transition-all" title="Shut Down Server">
                <i class="ri-shut-down-line ri-lg"></i>
            </button>
            <button id="closeBtn" class="w-10 h-10 flex items-center justify-center bg-gray-800 hover:bg-gray-700 !rounded-full text-white transition-all">
                <i class="ri-close-line ri-lg"></i>
            </button>
        </div>
        <!-- Scrollable content area -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow overflow-y-auto pb-4">
            <!-- Left Panel: Chart & Signal -->
            <div class="glassmorphism rounded-lg p-5 flex flex-col gap-y-4">
                <h2 class="text-xl font-semibold text-yellow-400">Price Chart & Signal</h2>
                <div id="priceChart" class="w-full h-[250px]"></div>
                <div class="flex justify-around items-center bg-gray-900/50 rounded-lg p-4">
                    <div>
                        <div class="text-sm text-gray-400">Signal</div>
                        <div id="tradeSignal" class="text-white font-bold text-2xl w-32 text-center transition-colors duration-300">...</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">Take Profit</div>
                        <div id="takeProfitPrice" class="text-xl font-medium text-green-400">...</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-400">Stop Loss</div>
                        <div id="stopLossPrice" class="text-xl font-medium text-red-400">...</div>
                    </div>
                </div>
            </div>
            <!-- Right Panel: Market Insights -->
            <div class="glassmorphism rounded-lg p-5 flex flex-col gap-y-4">
                <h2 class="text-xl font-semibold text-yellow-400">Market Insights</h2>
                <!-- RSI Gauge -->
                <div class="flex items-center gap-4">
                    <div id="rsiGauge" class="w-1/3 h-[150px]"></div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg">RSI (14)</h3>
                        <p id="rsiText" class="text-sm text-gray-300">...</p>
                    </div>
                </div>
                <!-- MACD & BB -->
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="text-base font-semibold">MACD Histogram</span>
                            <span id="macdValue" class="text-sm font-mono">...</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 relative">
                            <div id="macdBar" class="h-4 rounded-full absolute top-0 transition-all duration-500" style="width: 0%; left: 50%;"></div>
                        </div>
                    </div>
                    <div>
                        <span class="text-base font-semibold">Bollinger Band Position</span>
                        <div class="w-full bg-gray-700 rounded-full h-2.5 relative mt-2">
                            <div class="absolute w-full h-full border-y border-dashed border-gray-500"></div>
                            <div id="bbMarker" class="w-4 h-4 rounded-full bg-yellow-400 border-2 border-white absolute -top-1 transition-all duration-500" style="left: 50%;"></div>
                        </div>
                    </div>
                </div>
                <!-- Base Models -->
                <div>
                    <h3 class="text-lg font-semibold mt-4 mb-2">Base Model Analysis</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <i id="base15mIcon" class="ri-robot-2-line text-3xl mb-1"></i>
                            <div class="text-sm text-gray-400">15m Model</div>
                            <div id="base15m" class="font-semibold">...</div>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <i id="base1hIcon" class="ri-robot-2-line text-3xl mb-1"></i>
                            <div class="text-sm text-gray-400">1H Model</div>
                            <div id="base1h" class="font-semibold">...</div>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <i id="base4hIcon" class="ri-robot-2-line text-3xl mb-1"></i>
                            <div class="text-sm text-gray-400">4H Model</div>
                            <div id="base4h" class="font-semibold">...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Element Selectors ---
    const startBtn = document.getElementById('startBtn');
    const closeBtn = document.getElementById('closeBtn');
    const shutdownBtn = document.getElementById('shutdownBtn');
    const overlay = document.getElementById('overlay');
    
    // Prediction display elements
    const tradeSignalDiv = document.getElementById('tradeSignal');
    const takeProfitPriceDiv = document.getElementById('takeProfitPrice');
    const stopLossPriceDiv = document.getElementById('stopLossPrice');
    const base15mDiv = document.getElementById('base15m');
    const base1hDiv = document.getElementById('base1h');
    const base4hDiv = document.getElementById('base4h');
    const base15mIcon = document.getElementById('base15mIcon');
    const base1hIcon = document.getElementById('base1hIcon');
    const base4hIcon = document.getElementById('base4hIcon');

    // Metrics display elements
    const rsiText = document.getElementById('rsiText');
    const macdValue = document.getElementById('macdValue');
    const macdBar = document.getElementById('macdBar');
    const bbMarker = document.getElementById('bbMarker');

    // Chart instances
    const priceChart = echarts.init(document.getElementById('priceChart'));
    const rsiGauge = echarts.init(document.getElementById('rsiGauge'));
    let refreshIntervalId = null;

    // --- Chart & Gauge Initialization ---
    function initializeCharts() {
        const commonTextstyle = { color: 'rgba(255, 255, 255, 0.7)' };
        priceChart.setOption({
            backgroundColor: 'transparent',
            tooltip: { trigger: 'axis', backgroundColor: 'rgba(30, 41, 59, 0.9)', borderColor: '#f59e0b', textStyle: { color: '#fff' } },
            grid: { left: '12%', right: '5%', bottom: '15%', top: '10%' },
            xAxis: { type: 'category', data: [], axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } }, axisLabel: { ...commonTextstyle } },
            yAxis: { type: 'value', scale: true, axisLabel: { formatter: '${value}', ...commonTextstyle }, splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } } },
            series: [{ name: 'Price', type: 'line', data: [], smooth: true, showSymbol: false, lineStyle: { width: 3, color: '#f59e0b' } }]
        });
        rsiGauge.setOption({
            series: [{
                type: 'gauge',
                startAngle: 180,
                endAngle: 0,
                min: 0,
                max: 100,
                radius: '100%',
                center: ['50%', '65%'],
                splitNumber: 5,
                axisLine: {
                    lineStyle: {
                        width: 12,
                        color: [
                            [0.3, '#ef4444'], // Red for oversold
                            [0.7, '#f59e0b'], // Yellow for neutral
                            [1, '#22c55e']    // Green for overbought
                        ]
                    }
                },
                pointer: {
                    length: '60%',
                    width: 4,
                    itemStyle: { color: 'auto' }
                },
                axisTick: {
                    show: true,
                    length: 6,
                    distance: -12,
                    lineStyle: { color: 'auto' }
                },
                splitLine: {
                    show: true,
                    length: 12,
                    distance: -12,
                    lineStyle: { color: 'auto', width: 2 }
                },
                axisLabel: {
                    color: '#fff',
                    distance: 15,
                    fontSize: 10
                },
                detail: {
                    valueAnimation: true,
                    formatter: '{value}',
                    color: '#fff',
                    fontSize: 16,
                    offsetCenter: [0, '30%']
                },
                data: [{ value: 50 }]
            }]
        });
    }
    initializeCharts();

    // --- Event Listeners ---
    startBtn.addEventListener('click', fetchAndDisplayPrediction);
    closeBtn.addEventListener('click', () => {
        overlay.classList.remove('active');
        if (refreshIntervalId) clearInterval(refreshIntervalId);
    });
    shutdownBtn.addEventListener('click', async () => {
        if (confirm('Are you sure you want to shut down the server? This will stop all operations.')) {
            shutdownBtn.disabled = true;
            shutdownBtn.classList.add('opacity-50', 'cursor-wait');
            try {
                const response = await fetch('http://127.0.0.1:8000/shutdown');
                const data = await response.json();
                alert(data.message || 'Server shutdown initiated you can close the browser.');
                overlay.classList.remove('active');
                if (refreshIntervalId) clearInterval(refreshIntervalId);
            } catch (error) {
                console.error('Shutdown error:', error);
                alert('Failed to shut down the server: ' + error.message);
            } finally {
                shutdownBtn.disabled = false;
                shutdownBtn.classList.remove('opacity-50', 'cursor-wait');
            }
        }
    });

    // --- Main Fetch Function ---
    async function fetchAndDisplayPrediction() {
        if (refreshIntervalId) clearInterval(refreshIntervalId);
        overlay.classList.add('active');
        startBtn.disabled = true;
        startBtn.textContent = 'Analyzing...';
        setLoadingState();
        try {
            const response = await fetch('http://127.0.0.1:8000/predict');
            const data = await response.json();
            if (!response.ok || data.error) throw new Error(data.error || `HTTP error! status: ${response.status}`);
            updateUI(data);
            refreshIntervalId = setInterval(fetchAndDisplayPrediction, 900000); // Auto-refresh every 15 mins
        } catch (error) {
            console.error('Fetch error:', error);
            updateUIError(error.message);
        } finally {
            startBtn.disabled = false;
            startBtn.textContent = 'Start Analysis';
        }
    }

    // Auto call /predict every 900 seconds after first call on page load
    fetchAndDisplayPrediction();

    // --- UI Update Functions ---
    function setLoadingState() {
        const loadingText = '...';
        tradeSignalDiv.textContent = loadingText;
        takeProfitPriceDiv.textContent = loadingText;
        stopLossPriceDiv.textContent = loadingText;
        base15mDiv.textContent = loadingText;
        base1hDiv.textContent = loadingText;
        base4hDiv.textContent = loadingText;
        rsiText.textContent = 'Calculating...';
    }

    function updateUI(data) {
        // Helper to format numbers or show 'N/A'
        const formatPrice = (price) => price !== null ? `$${price.toFixed(2)}` : 'N/A';

        // Update main signals
        tradeSignalDiv.textContent = data.direction;
        takeProfitPriceDiv.textContent = formatPrice(data.tp_price);
        stopLossPriceDiv.textContent = formatPrice(data.sl_price);

        // Update base models
        base15mDiv.textContent = formatPrice(data.base_15m_pred_price);
        base1hDiv.textContent = formatPrice(data.base_1h_pred_price);
        base4hDiv.textContent = formatPrice(data.base_4h_pred_price);

        // Update signal & icon colors
        updateColors(tradeSignalDiv, data.direction);
        updateColors(base15mIcon, data.base_15m_direction === 1 ? 'BUY' : 'SELL', true);
        updateColors(base1hIcon, data.base_1h_direction === 1 ? 'BUY' : 'SELL', true);
        updateColors(base4hIcon, data.base_4h_direction === 1 ? 'BUY' : 'SELL', true);

        // Update Chart and Metrics
        updatePriceChart(data.historical_data, data.meta_pred_price);
        updateMetrics(data.latest_metrics);
    }

    function updateColors(element, direction, isIcon = false) {
        const classes = isIcon ? ['text-green-500', 'text-red-500', 'text-yellow-500'] : ['bg-green-600', 'bg-red-600', 'bg-yellow-600'];
        element.classList.remove(...classes);
        if (direction === 'BUY') element.classList.add(isIcon ? classes[0] : classes[0]);
        else if (direction === 'SELL') element.classList.add(isIcon ? classes[1] : classes[1]);
        else element.classList.add(isIcon ? classes[2] : classes[2]);
    }

    function updatePriceChart(historical, predictedPrice) {
        const times = historical.map(d => new Date(d.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        const prices = historical.map(d => d.close);

        priceChart.setOption({
            xAxis: { data: times },
            series: [{
                data: prices,
                // Highlight the predicted candle
                markPoint: {
                    symbol: 'pin',
                    symbolSize: 50,
                    data: [{
                        name: 'Prediction',
                        value: predictedPrice.toFixed(2),
                        xAxis: times.length, // Place it just after the last historical point
                        yAxis: predictedPrice,
                        itemStyle: { color: '#fcd34d' },
                        label: { color: '#000', fontWeight: 'bold' }
                    }]
                }
            }]
        });
    }

    function updateMetrics(metrics) {
        // RSI
        const rsiValue = parseFloat(metrics.rsi).toFixed(1);
        rsiGauge.setOption({ series: [{ data: [{ value: rsiValue }] }] });
        if(rsiValue > 70) rsiText.textContent = "Overbought. Potential for a price correction downwards.";
        else if(rsiValue < 30) rsiText.textContent = "Oversold. Potential for a price bounce upwards.";
        else rsiText.textContent = "Neutral momentum. The market is balanced.";

        // MACD
        const macd = metrics.macd_hist;
        macdValue.textContent = macd.toFixed(4);
        const macdWidth = Math.min(Math.abs(macd) * 200, 50); // Scale for viz, cap at 50%
        macdBar.style.width = `${macdWidth}%`;
        if (macd > 0) {
            macdBar.style.left = '50%';
            macdBar.style.backgroundColor = '#22c55e'; // green
        } else {
            macdBar.style.left = `${50 - macdWidth}%`;
            macdBar.style.backgroundColor = '#ef4444'; // red
        }

        // Bollinger Bands
        const bbPos = Math.max(0, Math.min(1, metrics.bb_pos)) * 100; // Clamp between 0 and 100
        bbMarker.style.left = `calc(${bbPos}% - 8px)`; // 8px is half the marker width
    }

    function updateUIError(errorMessage) {
        tradeSignalDiv.textContent = 'Error';
        updateColors(tradeSignalDiv, 'ERROR');
        console.error("Detailed Error:", errorMessage);
    }
});
</script>
</body>
</html>
